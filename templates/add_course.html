{% extends "base.html" %}

{% block content %}
<!-- 1. LOAD LIBRARY QUILL (CSS & JS) -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

<!-- CSS Kustom -->
<style>
    .ql-container { font-family: inherit; font-size: 1rem; border-bottom-left-radius: 0.5rem; border-bottom-right-radius: 0.5rem; }
    .ql-toolbar { border-top-left-radius: 0.5rem; border-top-right-radius: 0.5rem; }
    .ql-editor { min-height: 200px; }
</style>

<div class="min-h-screen bg-gray-50 py-8 px-4 sm:px-6 lg:px-8">
    <div class="max-w-4xl mx-auto">
        <a href="{{ url_for('admin_panel') }}" class="flex items-center gap-2 text-gray-600 hover:text-blue-600 transition-colors mb-6">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/></svg>
            Kembali ke Dashboard
        </a>

        <div class="bg-white rounded-2xl shadow-lg p-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-8 border-l-4 border-blue-600 pl-4">
                {{ 'Edit Kursus' if course else 'Tambah Kursus Baru' }}
            </h1>

            <form method="POST" enctype="multipart/form-data" id="courseForm" class="space-y-6">
                
                <!-- BAGIAN 1: INFORMASI DASAR (Sama seperti sebelumnya) -->
                <div class="space-y-4">
                    <h2 class="text-xl font-bold text-gray-800 pb-2 border-b">Informasi Dasar</h2>
                    
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Judul Kursus *</label>
                            <input type="text" name="title" value="{{ course.title if course else '' }}" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-600 outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Instruktur *</label>
                            <input type="text" name="instructor" value="{{ course.instructor if course else '' }}" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-600 outline-none">
                        </div>
                    </div>

                    <!-- Upload Gambar -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Gambar Sampul</label>
                        <div class="flex items-start gap-6 bg-gray-50 p-4 rounded-lg border border-gray-200">
                            <div class="shrink-0">
                                <div class="w-40 h-24 bg-gray-200 rounded-lg overflow-hidden border border-gray-300 relative">
                                    <img id="imagePreview" 
                                         src="{{ (course.image if 'http' in course.image else url_for('static', filename='uploads/' + course.image)) if course and course.image else 'https://via.placeholder.com/300x200?text=No+Image' }}" 
                                         class="w-full h-full object-cover" 
                                         alt="Preview">
                                </div>
                            </div>
                            <div class="flex-1">
                                <input type="file" name="image_file" id="imageInput" accept="image/*" onchange="previewImage(event)"
                                       class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-100 file:text-blue-700 hover:file:bg-blue-200 cursor-pointer border border-gray-300 rounded-lg bg-white">
                                <p class="mt-2 text-xs text-gray-500">Format: JPG, PNG, atau WEBP. Maksimal 2MB.</p>
                            </div>
                        </div>
                    </div>

                    <div class="grid md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Kategori *</label>
                            <select name="category" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-600 outline-none bg-white">
                                <option value="IT" {% if course and course.category == 'IT' %}selected{% endif %}>IT & Software</option>
                                <option value="Office" {% if course and course.category == 'Office' %}selected{% endif %}>Microsoft Office</option>
                                <option value="Desain" {% if course and course.category == 'Desain' %}selected{% endif %}>Desain Grafis</option>
                                <option value="Bisnis" {% if course and course.category == 'Bisnis' %}selected{% endif %}>Bisnis Digital</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Level *</label>
                            <select name="level" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-600 outline-none bg-white">
                                <option value="Pemula" {% if course and course.level == 'Pemula' %}selected{% endif %}>Pemula</option>
                                <option value="Menengah" {% if course and course.level == 'Menengah' %}selected{% endif %}>Menengah</option>
                                <option value="Lanjutan" {% if course and course.level == 'Lanjutan' %}selected{% endif %}>Lanjutan</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Estimasi Durasi *</label>
                            <input type="text" name="duration" value="{{ course.duration if course else '' }}" placeholder="Contoh: 8 Minggu" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-600 outline-none">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Deskripsi Singkat *</label>
                        <textarea name="description" rows="3" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-600 outline-none">{{ course.description if course else '' }}</textarea>
                    </div>
                </div>

                <!-- BAGIAN 2: HARGA -->
                <div class="space-y-4 border-t pt-6">
                    <h2 class="text-xl font-bold text-gray-800 pb-2 border-b">Harga & Diskon</h2>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Harga (Rp) *</label>
                            <input type="number" name="price" value="{{ course.price if course else 0 }}" min="0" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-600 outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Diskon (%) *</label>
                            <input type="number" name="discount" value="{{ course.discount if course else 0 }}" min="0" max="100" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-600 outline-none">
                        </div>
                    </div>
                </div>

                <!-- BAGIAN 3: MATERI PELAJARAN (BUILDER DENGAN FITUR EDIT) -->
                <div class="space-y-4 border-t pt-6">
                    <h2 class="text-xl font-bold text-gray-800 pb-2 border-b">Materi Pelajaran</h2>
                    <input type="hidden" name="lessons_json" id="lessonsJson">

                    <!-- BUILDER FORM AREA -->
                    <div id="lessonBuilder" class="bg-blue-50 p-6 rounded-xl border border-blue-100 space-y-4 scroll-mt-20">
                        <div class="flex justify-between items-center">
                            <h3 class="font-bold text-gray-800 flex items-center gap-2">
                                <span class="bg-blue-600 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs" id="modeIcon">+</span>
                                <span id="modeTitle">Tambah Materi Baru</span>
                            </h3>
                            <!-- Tombol Batal Edit (Hanya muncul saat edit) -->
                            <button type="button" onclick="cancelEdit()" id="btnCancelEdit" class="hidden text-xs text-red-600 hover:underline">Batal Edit</button>
                        </div>
                        
                        <!-- Input Data -->
                        <div class="grid md:grid-cols-3 gap-4">
                            <input type="text" id="newLessonTitle" placeholder="Judul pelajaran" class="px-4 py-2 border border-gray-300 rounded-lg outline-none focus:ring-2 focus:ring-blue-600 bg-white">
                            <input type="text" id="newLessonDuration" placeholder="Durasi (cth: 15 menit)" class="px-4 py-2 border border-gray-300 rounded-lg outline-none focus:ring-2 focus:ring-blue-600 bg-white">
                            <select id="newLessonType" onchange="toggleContentInput()" class="px-4 py-2 border border-gray-300 rounded-lg outline-none focus:ring-2 focus:ring-blue-600 bg-white font-medium text-gray-700">
                                <option value="video">Video Saja</option>
                                <option value="text">Teks Saja</option>
                                <option value="video_text" class="text-purple-700 font-bold">Video + Teks (Materi Lengkap)</option>
                                <option value="quiz">Kuis / Latihan Soal</option>
                            </select>
                        </div>

                        <!-- AREA KONTEN -->
                        <div id="contentArea" class="space-y-4 p-4 bg-white rounded-lg border border-gray-200">
                            <!-- 1. Video -->
                            <div id="inputVideo" class="block">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Link Video (YouTube Embed/URL) <span class="text-red-500">*</span></label>
                                <input type="url" id="videoUrl" placeholder="https://www.youtube.com/embed/..." class="w-full px-4 py-2 border border-gray-300 rounded-lg outline-none focus:ring-2 focus:ring-blue-600">
                            </div>
                            <!-- 2. Teks -->
                            <div id="inputText" class="hidden">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Isi Materi Teks <span class="text-red-500">*</span></label>
                                <div class="bg-white"><div id="quill-editor"></div></div>
                            </div>
                            <!-- 3. Quiz -->
                            <div id="inputQuiz" class="hidden space-y-4">
                                <div class="flex justify-between items-center border-b pb-2">
                                    <label class="block text-sm font-medium text-gray-700">Daftar Pertanyaan</label>
                                    <button type="button" onclick="addQuizQuestion()" class="text-xs bg-blue-100 text-blue-700 px-3 py-1.5 rounded-full hover:bg-blue-200">+ Tambah Soal</button>
                                </div>
                                <div id="quizQuestionsContainer" class="space-y-4 max-h-[400px] overflow-y-auto pr-2"></div>
                            </div>
                        </div>

                        <!-- Tombol Aksi -->
                        <div class="flex items-center justify-between pt-2">
                            <label class="flex items-center gap-2 text-sm text-gray-700 cursor-pointer bg-white px-3 py-1 rounded border border-gray-200">
                                <input type="checkbox" id="newLessonPreview" class="rounded text-blue-600 focus:ring-blue-500 w-4 h-4"> Preview Gratis
                            </label>
                            <button type="button" onclick="saveLesson()" id="btnSaveLesson" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2 font-medium shadow-md">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/></svg>
                                <span>Simpan Materi ke Daftar</span>
                            </button>
                        </div>
                    </div>

                    <!-- DAFTAR LESSONS -->
                    <div class="mt-6">
                        <h3 class="font-bold text-gray-800 mb-3">Daftar Materi Pelajaran</h3>
                        <div id="lessonsList" class="space-y-3"></div>
                    </div>
                </div>

                <!-- Submit Utama -->
                <div class="flex gap-4 pt-6 border-t mt-8 sticky bottom-0 bg-white py-4 z-10 shadow-lg">
                    <a href="{{ url_for('admin_panel') }}" class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors text-center font-medium">Batal</a>
                    <button type="submit" class="flex-1 bg-gradient-to-r from-blue-600 to-indigo-600 text-white py-3 rounded-lg hover:from-blue-700 hover:to-indigo-700 transition-all font-bold shadow-lg">
                        {{ 'Simpan Perubahan Kursus' if course else 'Terbitkan Kursus Baru' }}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // --- SETUP PREVIEW & EDITOR ---
    function previewImage(event) {
        if(event.target.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e){ document.getElementById('imagePreview').src = e.target.result; };
            reader.readAsDataURL(event.target.files[0]);
        }
    }

    var quill = new Quill('#quill-editor', {
        theme: 'snow',
        modules: { toolbar: [[{ 'font': [] }, { 'size': ['small', false, 'large', 'huge'] }], ['bold', 'italic', 'underline'], [{ 'color': [] }, { 'background': [] }], [{ 'list': 'ordered'}, { 'list': 'bullet' }], ['link', 'clean']] },
        placeholder: 'Tulis materi di sini...'
    });

    // --- STATE MANAGEMENT ---
    let lessons = {{ lessons_json | default('[]') | safe }};
    let editingIndex = -1; // -1 artinya mode TAMBAH BARU, >=0 artinya mode EDIT

    // --- LOGIKA UTAMA (CRUD LESSON) ---

    // 1. Simpan atau Update Lesson
    function saveLesson() {
        // Ambil data dari form
        const title = document.getElementById('newLessonTitle').value.trim();
        const duration = document.getElementById('newLessonDuration').value.trim();
        const type = document.getElementById('newLessonType').value;
        const isPreview = document.getElementById('newLessonPreview').checked;
        
        // Validasi
        if (!title || !duration) { alert('Judul dan Durasi wajib diisi.'); return; }

        // Ambil Konten
        let content = '';
        const getQuillHTML = () => (quill.getText().trim().length === 0 && quill.root.innerHTML === '<p><br></p>') ? '' : quill.root.innerHTML;

        if (type === 'video') {
            content = document.getElementById('videoUrl').value.trim();
            if (!content) { alert('Link Video wajib diisi.'); return; }
        } else if (type === 'text') {
            content = getQuillHTML();
            if (!content) { alert('Materi Teks wajib diisi.'); return; }
        } else if (type === 'video_text') {
            const vid = document.getElementById('videoUrl').value.trim();
            const txt = getQuillHTML();
            if (!vid || !txt) { alert('Link Video DAN Teks wajib diisi.'); return; }
            content = { video: vid, text: txt };
        } else if (type === 'quiz') {
            content = collectQuizData();
            if (!content) return; // Error handled in collectQuizData
        }

        // Object Lesson Baru
        const lessonData = { title, duration, type, isPreview, content };

        if (editingIndex === -1) {
            // Mode Tambah
            lessons.push(lessonData);
        } else {
            // Mode Update
            lessons[editingIndex] = lessonData;
            resetEditMode(); // Kembali ke mode tambah
        }

        resetForm();
        renderLessons();
    }

    // 2. Edit Lesson (Memasukkan data ke form)
    function editLesson(index) {
        const l = lessons[index];
        editingIndex = index;

        // Ubah Tampilan ke Mode Edit
        document.getElementById('modeTitle').innerText = `Edit Materi: ${l.title}`;
        document.getElementById('modeIcon').innerText = '‚úé';
        document.getElementById('btnSaveLesson').innerHTML = `<span>Update Materi</span>`;
        document.getElementById('btnSaveLesson').className = "bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition-colors flex items-center gap-2 font-medium shadow-md";
        document.getElementById('btnCancelEdit').classList.remove('hidden');
        document.getElementById('lessonBuilder').classList.add('ring-2', 'ring-green-400'); // Highlight form

        // Scroll ke form
        document.getElementById('lessonBuilder').scrollIntoView({ behavior: 'smooth' });

        // Isi Form dengan Data Lama
        document.getElementById('newLessonTitle').value = l.title;
        document.getElementById('newLessonDuration').value = l.duration;
        document.getElementById('newLessonType').value = l.type;
        document.getElementById('newLessonPreview').checked = l.is_preview;

        // Trigger Toggle agar input yang sesuai muncul
        toggleContentInput();

        // Isi Konten Spesifik
        if (l.type === 'video') {
            document.getElementById('videoUrl').value = l.content;
        } else if (l.type === 'text') {
            quill.root.innerHTML = l.content;
        } else if (l.type === 'video_text') {
            document.getElementById('videoUrl').value = l.content.video;
            quill.root.innerHTML = l.content.text;
        } else if (l.type === 'quiz') {
            renderQuizBuilder(l.content);
        }
    }

    // 3. Hapus Lesson
    function removeLesson(index) {
        if(confirm('Hapus pelajaran ini?')) {
            if (index === editingIndex) resetEditMode();
            lessons.splice(index, 1);
            renderLessons();
        }
    }

    // 4. Reset Form & Mode
    function resetForm() {
        document.getElementById('newLessonTitle').value = '';
        document.getElementById('newLessonDuration').value = '';
        document.getElementById('videoUrl').value = '';
        quill.setContents([]);
        document.getElementById('quizQuestionsContainer').innerHTML = '';
        document.getElementById('newLessonPreview').checked = false;
        if (document.getElementById('newLessonType').value === 'quiz') addQuizQuestion();
    }

    function resetEditMode() {
        editingIndex = -1;
        document.getElementById('modeTitle').innerText = 'Tambah Materi Baru';
        document.getElementById('modeIcon').innerText = '+';
        document.getElementById('btnSaveLesson').innerHTML = `<span>Simpan Materi ke Daftar</span>`;
        document.getElementById('btnSaveLesson').className = "bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2 font-medium shadow-md";
        document.getElementById('btnCancelEdit').classList.add('hidden');
        document.getElementById('lessonBuilder').classList.remove('ring-2', 'ring-green-400');
        resetForm();
    }

    function cancelEdit() {
        resetEditMode();
    }

    // --- HELPER FUNCTIONS ---

    function toggleContentInput() {
        const type = document.getElementById('newLessonType').value;
        ['inputVideo', 'inputText', 'inputQuiz'].forEach(id => document.getElementById(id).classList.add('hidden'));

        if (type === 'video') document.getElementById('inputVideo').classList.remove('hidden');
        else if (type === 'text') document.getElementById('inputText').classList.remove('hidden');
        else if (type === 'video_text') {
            document.getElementById('inputVideo').classList.remove('hidden');
            document.getElementById('inputText').classList.remove('hidden');
        } else if (type === 'quiz') {
            document.getElementById('inputQuiz').classList.remove('hidden');
            if(document.getElementById('quizQuestionsContainer').children.length === 0 && editingIndex === -1) addQuizQuestion();
        }
    }

    // --- QUIZ LOGIC (Complex) ---
    function addQuizQuestion(data = null) {
        const qId = Date.now() + Math.random().toString(16).slice(2);
        const qText = data ? data.question : '';
        const qType = data ? data.type : 'multiple_choice';
        
        const html = `
            <div id="q-${qId}" class="bg-white p-4 rounded border border-gray-200 relative shadow-sm hover:shadow-md transition">
                <button type="button" onclick="this.parentElement.remove()" class="absolute top-2 right-2 text-gray-400 hover:text-red-500">‚úï</button>
                <div class="mb-3 pr-8">
                    <input type="text" class="q-text w-full px-3 py-2 border rounded mb-2 focus:ring-1 focus:ring-blue-500 outline-none" placeholder="Tulis Pertanyaan..." value="${qText}">
                    <select class="q-type w-full px-3 py-2 border rounded bg-gray-50 text-sm" onchange="toggleOptionInput('${qId}', this.value)">
                        <option value="multiple_choice" ${qType==='multiple_choice'?'selected':''}>Pilihan Ganda</option>
                        <option value="essay" ${qType==='essay'?'selected':''}>Essay / Isian</option>
                    </select>
                </div>
                <div id="opts-${qId}" class="space-y-2 pl-4 border-l-4 border-blue-100 ${qType==='essay'?'hidden':''}">
                    <div class="options-list space-y-2"></div>
                    <button type="button" onclick="addOption('${qId}')" class="text-xs text-blue-600 hover:text-blue-800 font-medium">+ Tambah Opsi Jawaban</button>
                </div>
            </div>
        `;
        document.getElementById('quizQuestionsContainer').insertAdjacentHTML('beforeend', html);
        
        // Isi opsi jika ada data lama
        if (data && data.options) {
            data.options.forEach((optText, idx) => addOption(qId, optText, idx === data.correctIndex));
        } else if (!data) {
            addOption(qId); addOption(qId); // Default 2 opsi kosong
        }
    }

    function addOption(qId, val='', isCorrect=false) {
        const optsList = document.querySelector(`#opts-${qId} .options-list`);
        const optHtml = `
            <div class="flex items-center gap-2">
                <input type="radio" name="correct-${qId}" class="opt-correct w-4 h-4 cursor-pointer" ${isCorrect?'checked':''}>
                <input type="text" class="opt-text w-full px-2 py-1 border rounded text-sm outline-none" placeholder="Opsi jawaban..." value="${val}">
                <button type="button" onclick="this.parentElement.remove()" class="text-gray-400 hover:text-red-500">‚úï</button>
            </div>
        `;
        optsList.insertAdjacentHTML('beforeend', optHtml);
    }

    function toggleOptionInput(qId, type) {
        const el = document.getElementById(`opts-${qId}`);
        if(type === 'essay') el.classList.add('hidden'); else el.classList.remove('hidden');
    }

    function collectQuizData() {
        const questions = [];
        let isValid = true;
        document.querySelectorAll('#quizQuestionsContainer > div').forEach(qDiv => {
            const qText = qDiv.querySelector('.q-text').value.trim();
            const qType = qDiv.querySelector('.q-type').value;
            if (qText) {
                let qData = { question: qText, type: qType };
                if (qType === 'multiple_choice') {
                    const options = [];
                    let correctIndex = -1;
                    qDiv.querySelectorAll('.options-list > div').forEach((optDiv, idx) => {
                        const val = optDiv.querySelector('.opt-text').value.trim();
                        if(val) {
                            options.push(val);
                            if(optDiv.querySelector('.opt-correct').checked) correctIndex = idx;
                        }
                    });
                    if (options.length < 2) { alert('Pertanyaan PG minimal punya 2 opsi.'); isValid=false; return; }
                    qData.options = options;
                    qData.correctIndex = correctIndex;
                }
                questions.push(qData);
            }
        });
        if (!isValid) return null;
        if (questions.length === 0) { alert('Minimal buat 1 pertanyaan kuis.'); return null; }
        return questions;
    }

    function renderQuizBuilder(quizData) {
        document.getElementById('quizQuestionsContainer').innerHTML = '';
        if(Array.isArray(quizData)) {
            quizData.forEach(q => addQuizQuestion(q));
        }
    }

    // --- RENDER LIST ---
    function renderLessons() {
        const container = document.getElementById('lessonsList');
        container.innerHTML = '';
        if (lessons.length === 0) {
            container.innerHTML = '<div class="text-center text-gray-400 py-6 text-sm border-2 border-dashed rounded-lg">Belum ada materi pelajaran.</div>';
            return;
        }
        
        const stripHtml = (html) => { let tmp = document.createElement("DIV"); tmp.innerHTML = html; return tmp.textContent || tmp.innerText || ""; }

        lessons.forEach((l, idx) => {
            let contentPreview = '', labelType = l.type.replace('_', ' + ').toUpperCase();
            let badgeClass = 'bg-blue-100 text-blue-700 border-blue-200';

            if (l.type === 'video') contentPreview = `üé• ${l.content}`;
            else if (l.type === 'text') { badgeClass='bg-green-100 text-green-700'; contentPreview = `üìÑ ${stripHtml(l.content).substring(0, 40)}...`; }
            else if (l.type === 'video_text') { badgeClass='bg-purple-100 text-purple-700'; contentPreview = `üé• ${l.content.video} | üìÑ Teks...`; }
            else if (l.type === 'quiz') { badgeClass='bg-yellow-100 text-yellow-700'; contentPreview = `‚ùì ${l.content.length} Soal`; }

            const html = `
                <div class="group flex items-center justify-between p-4 bg-white border border-gray-200 rounded-lg shadow-sm hover:shadow-md transition ${editingIndex === idx ? 'ring-2 ring-green-400 bg-green-50' : ''}">
                    <div class="flex items-start gap-4 overflow-hidden">
                        <div class="${badgeClass} px-2 py-1 rounded text-[10px] font-bold border min-w-[60px] text-center mt-1">${labelType}</div>
                        <div class="min-w-0">
                            <div class="font-bold text-gray-800 flex items-center gap-2">
                                <span class="text-gray-400 text-sm font-normal">#${idx + 1}</span>
                                <span class="truncate">${l.title}</span>
                            </div>
                            <div class="text-sm text-gray-500 mb-1">${l.duration} ${l.isPreview ? '‚Ä¢ <span class="text-green-600 font-bold text-xs">Preview</span>' : ''}</div>
                            <div class="text-xs text-gray-400 truncate max-w-[250px]">${contentPreview}</div>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <button type="button" onclick="editLesson(${idx})" class="text-blue-500 hover:text-blue-700 p-2 bg-blue-50 rounded-lg hover:bg-blue-100 transition" title="Edit Pelajaran">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg>
                        </button>
                        <button type="button" onclick="removeLesson(${idx})" class="text-red-500 hover:text-red-700 p-2 bg-red-50 rounded-lg hover:bg-red-100 transition" title="Hapus Pelajaran">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                        </button>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
        });
    }

    // --- SUBMIT UTAMA ---
    document.getElementById('courseForm').addEventListener('submit', function(e) {
        document.getElementById('lessonsJson').value = JSON.stringify(lessons);
    });

    renderLessons();
    toggleContentInput();
</script>
{% endblock %}