{% extends "base.html" %}

{% block content %}
<!-- Sembunyikan Navbar & Footer Default -->
<style>
    nav, footer { display: none !important; }
    /* Styling untuk konten teks dari Quill Editor */
    .prose img { border-radius: 0.5rem; margin: 1rem 0; max-width: 100%; }
    .prose h1 { font-size: 1.5rem; font-weight: bold; margin-bottom: 1rem; color: #fff; }
    .prose h2 { font-size: 1.25rem; font-weight: bold; margin-bottom: 0.75rem; color: #e5e7eb; }
    .prose p { margin-bottom: 0.75rem; line-height: 1.6; color: #d1d5db; }
    .prose ul { list-style-type: disc; padding-left: 1.5rem; margin-bottom: 1rem; color: #d1d5db; }
    .prose ol { list-style-type: decimal; padding-left: 1.5rem; margin-bottom: 1rem; color: #d1d5db; }
    .prose blockquote { border-left: 4px solid #3b82f6; padding-left: 1rem; color: #9ca3af; font-style: italic; }
    .prose a { color: #60a5fa; text-decoration: underline; }
</style>

<div class="min-h-screen bg-gray-900 text-white flex flex-col">
    <!-- Header Learning -->
    <div class="bg-gray-800 border-b border-gray-700 sticky top-0 z-50 shadow-md">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex items-center justify-between">
                <a href="{{ url_for('my_courses') }}" class="flex items-center gap-2 text-gray-300 hover:text-white transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/></svg>
                    Kembali ke Kursus
                </a>

                <div class="flex items-center gap-4">
                    <div class="text-sm text-gray-400">
                        Progress: <span class="text-white font-bold" id="progressText">{{ progress_percent }}%</span>
                    </div>
                    <div class="w-32 h-2 bg-gray-700 rounded-full overflow-hidden">
                        <div id="progressBar" class="h-full bg-gradient-to-r from-blue-500 to-indigo-500 transition-all duration-500" style="width: {{ progress_percent }}%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="flex-grow max-w-7xl mx-auto w-full px-4 sm:px-6 lg:px-8 py-6">
        <div class="grid lg:grid-cols-3 gap-8 h-full">
            
            <!-- MAIN CONTENT AREA (KIRI) -->
            <div class="lg:col-span-2 space-y-6">
                
                <!-- 1. AREA VIDEO (Dinamis) -->
                <div id="videoContainer" class="hidden bg-black rounded-xl overflow-hidden shadow-2xl aspect-video relative border border-gray-800">
                    <iframe id="videoPlayer" class="w-full h-full" src="" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                </div>

                <!-- 2. AREA TEKS (Dinamis) -->
                <div id="textContainer" class="hidden bg-gray-800 rounded-xl p-8 shadow-xl border border-gray-700">
                    <div id="textContent" class="prose max-w-none">
                        <!-- Konten HTML akan diinject di sini -->
                    </div>
                </div>

                <!-- 3. AREA KUIS (Placeholder) -->
                <div id="quizContainer" class="hidden bg-gray-800 rounded-xl p-10 shadow-xl text-center border border-gray-700">
                    <div class="bg-gray-700 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6">
                        <svg class="w-10 h-10 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                    </div>
                    <h3 class="text-2xl font-bold text-white mb-3">Kuis Latihan</h3>
                    <p class="text-gray-400 mb-8 text-lg">Kerjakan kuis ini untuk menguji pemahaman Anda terhadap materi.</p>
                    <button class="bg-blue-600 text-white px-8 py-3 rounded-lg hover:bg-blue-700 font-bold transition-transform transform hover:scale-105">
                        Mulai Kuis
                    </button>
                </div>

                <!-- JUDUL & KONTROL PELAJARAN -->
                <div class="bg-gray-800 rounded-xl p-6 shadow-xl border-t border-gray-700">
                    <div class="flex flex-col sm:flex-row sm:items-start justify-between gap-4 mb-4">
                        <div class="flex-1">
                            <h1 class="text-2xl font-bold text-white mb-2" id="lessonTitle">Memuat...</h1>
                            <div class="flex items-center gap-4 text-sm text-gray-400">
                                <span id="lessonIndex">Pelajaran -</span>
                                <span>â€¢</span>
                                <span id="lessonDuration">-- menit</span>
                            </div>
                        </div>
                        
                        <!-- Tombol Mark Complete -->
                        <button id="btnMarkComplete" onclick="markComplete()" class="hidden bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition-colors flex items-center gap-2 shadow-lg font-medium">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                            Tandai Selesai
                        </button>
                        
                        <div id="badgeCompleted" class="hidden bg-green-900/30 text-green-400 px-6 py-3 rounded-lg flex items-center gap-2 border border-green-500/30 font-medium cursor-default">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                            Selesai
                        </div>
                    </div>

                    <!-- Tombol Navigasi -->
                    <div class="flex gap-3 pt-6 border-t border-gray-700 mt-4">
                        <button onclick="prevLesson()" id="btnPrev" disabled class="flex-1 border border-gray-600 text-gray-300 py-3 rounded-lg hover:bg-gray-700 hover:text-white transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                            Sebelumnya
                        </button>
                        <button onclick="nextLesson()" id="btnNext" disabled class="flex-1 bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2 shadow-lg">
                            Berikutnya
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                        </button>
                    </div>
                </div>

                <!-- Info Instruktur -->
                <div class="bg-gray-800 rounded-xl p-6 shadow-xl border border-gray-700">
                    <h3 class="text-lg font-bold text-white mb-2">Instruktur</h3>
                    <p class="text-gray-400">{{ course.instructor }}</p>
                </div>
            </div>

            <!-- SIDEBAR LIST (KANAN) -->
            <div class="lg:col-span-1">
                <div class="bg-gray-800 rounded-xl shadow-xl overflow-hidden sticky top-24 border border-gray-700">
                    <div class="p-5 bg-gray-900 border-b border-gray-700">
                        <h3 class="text-lg font-bold text-white">Daftar Materi</h3>
                        <p class="text-gray-400 text-sm mt-1">{{ course.lessons|length }} Pelajaran â€¢ {{ course.duration }}</p>
                    </div>

                    <div class="max-h-[600px] overflow-y-auto custom-scrollbar" id="lessonList">
                        {% for lesson in course.lessons %}
                        <button 
                            onclick="loadLesson({{ loop.index0 }})"
                            id="lesson-btn-{{ loop.index0 }}"
                            class="w-full p-4 text-left border-b border-gray-700 hover:bg-gray-700 transition-colors flex items-start gap-3 group focus:outline-none"
                        >
                            <!-- Icon Status -->
                            <div class="mt-0.5" id="icon-status-{{ lesson.id }}">
                                {% if lesson.id in completed_lesson_ids %}
                                <svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                {% else %}
                                    {% if lesson.type == 'video' or lesson.type == 'video_text' %}
                                    <svg class="w-5 h-5 text-gray-500 group-hover:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                    {% else %}
                                    <svg class="w-5 h-5 text-gray-500 group-hover:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                                    {% endif %}
                                {% endif %}
                            </div>
                            
                            <div class="flex-1">
                                <div class="mb-1 text-sm font-medium text-gray-300 group-hover:text-white transition-colors leading-tight" id="title-text-{{ loop.index0 }}">
                                    {{ loop.index }}. {{ lesson.title }}
                                </div>
                                <div class="text-xs text-gray-500">{{ lesson.duration }}</div>
                            </div>
                        </button>
                        {% endfor %}
                    </div>

                    <!-- Certificate Button -->
                    <div id="certButtonArea" class="p-6 bg-gradient-to-r from-yellow-600 to-yellow-500 {{ 'hidden' if progress_percent < 100 }}">
                        <a href="{{ url_for('view_certificate', course_id=course.id) }}" class="w-full bg-white text-yellow-700 py-3 rounded-lg hover:bg-yellow-50 transition-colors flex items-center justify-center gap-2 font-bold shadow-lg">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"/></svg>
                            Lihat Sertifikat
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Certificate Popup -->
    <div id="certPopup" class="fixed inset-0 bg-black/90 hidden items-center justify-center z-50 p-4 backdrop-blur-sm transition-opacity">
        <div class="bg-gray-800 border border-gray-700 rounded-2xl p-8 max-w-md w-full text-center shadow-2xl">
            <div class="bg-yellow-500 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6 shadow-lg animate-bounce">
                <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"/></svg>
            </div>
            <h2 class="text-3xl font-bold text-white mb-2">Selamat! ðŸŽ‰</h2>
            <p class="text-gray-400 mb-8">Anda telah menyelesaikan seluruh pelajaran. Sertifikat kelulusan Anda sudah siap!</p>
            <div class="space-y-3">
                <a href="{{ url_for('view_certificate', course_id=course.id) }}" class="block w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition-colors font-bold">
                    Lihat Sertifikat
                </a>
                <button onclick="document.getElementById('certPopup').classList.replace('flex', 'hidden')" class="w-full border border-gray-600 text-gray-300 py-3 rounded-lg hover:bg-gray-700 transition-colors">
                    Tutup
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    // --- 1. DATA PREPARATION ---
    // Serialisasi data JSON dari server agar aman dibaca JS
    const lessons = [
        {% for lesson in course.lessons %}
        { 
            id: {{ lesson.id }}, 
            title: "{{ lesson.title }}", 
            duration: "{{ lesson.duration }}",
            type: "{{ lesson.type }}",
            content: {{ lesson.content | tojson if lesson.content else 'null' }} 
        },
        {% endfor %}
    ];
    
    let completedIds = {{ completed_lesson_ids | tojson }};
    let currentIndex = 0;
    const courseId = {{ course.id }};

    // --- FUNGSI FIX YOUTUBE EMBED ---
    function convertToEmbedUrl(url) {
        if (!url) return "";
        // Regex pintar untuk menangkap ID Video Youtube (Support: youtu.be, watch?v=, embed, dll)
        const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
        const match = url.match(regExp);

        if (match && match[2].length === 11) {
            // Return link embed resmi YouTube
            return `https://www.youtube.com/embed/${match[2]}?autoplay=0&rel=0`;
        } else {
            // Jika bukan youtube (misal mp4 biasa), kembalikan aslinya
            return url; 
        }
    }

    // --- 2. LOGIKA RENDER HALAMAN ---
    function loadLesson(index) {
        currentIndex = index;
        const l = lessons[index];
        
        // Update Info Header
        document.getElementById('lessonTitle').innerText = l.title;
        document.getElementById('lessonIndex').innerText = `Pelajaran ${index + 1} dari ${lessons.length}`;
        document.getElementById('lessonDuration').innerText = l.duration;

        // Reset Tampilan
        document.getElementById('videoContainer').classList.add('hidden');
        document.getElementById('textContainer').classList.add('hidden');
        document.getElementById('quizContainer').classList.add('hidden');
        document.getElementById('videoPlayer').src = "";
        document.getElementById('textContent').innerHTML = "";

        // --- LOGIKA KONTEN ---
        
        // Case A: Video Only
        if (l.type === 'video') {
            document.getElementById('videoContainer').classList.remove('hidden');
            // Gunakan fungsi convert agar link youtube aman
            document.getElementById('videoPlayer').src = convertToEmbedUrl(l.content);
        } 
        // Case B: Text Only
        else if (l.type === 'text') {
            document.getElementById('textContainer').classList.remove('hidden');
            document.getElementById('textContent').innerHTML = l.content;
        } 
        // Case C: Video + Text (Gabungan)
        else if (l.type === 'video_text') {
            let data = l.content;
            // Parse JSON jika masih bentuk string
            if (typeof data === 'string') {
                try { data = JSON.parse(data); } catch(e) { console.error("Error parse JSON", e); }
            }

            if (data) {
                // Video
                document.getElementById('videoContainer').classList.remove('hidden');
                document.getElementById('videoPlayer').src = convertToEmbedUrl(data.video);
                
                // Teks
                document.getElementById('textContainer').classList.remove('hidden');
                document.getElementById('textContent').innerHTML = data.text || "";
            }
        }
        // Case D: Quiz
        else if (l.type === 'quiz') {
            document.getElementById('quizContainer').classList.remove('hidden');
        }

        // Update Sidebar Active State
        document.querySelectorAll('[id^="lesson-btn-"]').forEach(btn => {
            btn.classList.remove('bg-gray-700', 'border-l-4', 'border-l-blue-500');
            btn.querySelector('[id^="title-text-"]').classList.remove('text-blue-400', 'font-bold');
        });
        const activeBtn = document.getElementById(`lesson-btn-${index}`);
        if(activeBtn) {
            activeBtn.classList.add('bg-gray-700', 'border-l-4', 'border-l-blue-500');
            activeBtn.querySelector(`#title-text-${index}`).classList.add('text-blue-400', 'font-bold');
        }

        // Update Status Buttons
        updateStatusButtons(l.id);
        
        // Disable Prev/Next di ujung
        document.getElementById('btnPrev').disabled = index === 0;
        document.getElementById('btnNext').disabled = index === lessons.length - 1;
        
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function updateStatusButtons(lessonId) {
        const isCompleted = completedIds.includes(lessonId);
        if (isCompleted) {
            document.getElementById('btnMarkComplete').classList.add('hidden');
            document.getElementById('badgeCompleted').classList.remove('hidden');
        } else {
            document.getElementById('btnMarkComplete').classList.remove('hidden');
            document.getElementById('badgeCompleted').classList.add('hidden');
        }
    }

    function nextLesson() {
        if (currentIndex < lessons.length - 1) loadLesson(currentIndex + 1);
    }

    function prevLesson() {
        if (currentIndex > 0) loadLesson(currentIndex - 1);
    }

    // --- 3. AJAX MARK COMPLETE ---
    function markComplete() {
        const currentLesson = lessons[currentIndex];
        
        const btn = document.getElementById('btnMarkComplete');
        const oriText = btn.innerHTML;
        btn.innerHTML = 'Menyimpan...';
        btn.disabled = true;

        fetch('/api/mark-complete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ course_id: courseId, lesson_id: currentLesson.id })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                if (!completedIds.includes(currentLesson.id)) completedIds.push(currentLesson.id);
                
                document.getElementById('progressText').innerText = data.progress + '%';
                document.getElementById('progressBar').style.width = data.progress + '%';
                
                // Update Icon Sidebar
                const iconDiv = document.getElementById(`icon-status-${currentLesson.id}`);
                if(iconDiv) iconDiv.innerHTML = '<svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>';
                
                updateStatusButtons(currentLesson.id);

                if (data.is_completed) {
                    document.getElementById('certButtonArea').classList.remove('hidden');
                    document.getElementById('certPopup').classList.remove('hidden');
                    document.getElementById('certPopup').classList.add('flex');
                }
            }
        })
        .catch(err => console.error(err))
        .finally(() => {
            btn.innerHTML = oriText;
            btn.disabled = false;
        });
    }

    // Init Load
    window.onload = function() {
        if (lessons.length > 0) loadLesson(0);
    };
</script>
{% endblock %}